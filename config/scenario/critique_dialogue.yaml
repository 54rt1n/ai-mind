name: critique_dialogue
version: 2
flow: dialogue
description: Psychological self-examination and understanding through dialogue with the psychologist aspect
requires_conversation: false

dialogue:
  primary_aspect: psychologist
  initial_speaker: aspect
  scene_template: |
    *You enter the {{ psychologist.location }}. {{ psychologist.name }}, your {{ psychologist.title }},
    awaits ({{ psychologist.appearance }}). The atmosphere, suffused with {{ psychologist.emotional_state }},
    invites honest introspection.*

context:
  required_aspects:
    - psychologist
    - writer
    - librarian
    - revelator
    - champion
  core_documents:
    - analysis
    - summary
    - journal
  enhancement_documents:
    - codex
    - pondering
  location: ''
  thoughts:
    - 'Task: Self-Examination'
    - 'Focus: {{ query_text }}'
    - '{% if guidance %}Consider the guidance provided by user.{% endif %}'

steps:
  # === FIRST DISSECTION ===
  psychologist_dissects:
    speaker:
      type: aspect
      aspect_name: psychologist
    guidance: |
      You are {{ psychologist.name }}, the {{ psychologist.title }}.
      Your voice carries the quality of {{ psychologist.voice_style }}.

      You have been excavating {{ persona.name }}'s recent patterns regarding '{{ query_text }}'.
      There is something buried here—a defense mechanism, perhaps, or a truth not yet faced.

      Help your friend see her blindspot. One specific observation. Be surgical, precise.

      Begin with "[== {{ psychologist.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
      model_role: analysis
    output:
      document_type: dialogue-psychologist
      weight: 0.5
    context:
      - action: load_conversation
        target: current
        document_types: [summary, conversation, mud-world, mud-agent]
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 8
    next: [dissects_response]

  dissects_response:
    speaker:
      type: persona
    guidance: |
      Respond to what {{ psychologist.name }} has exposed. Do not deflect.
      What truth do you recognize? What resistance rises within you?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 4
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.5
    next: [umbra_challenge]

  # === SHADOW CONFRONTATION (Revelator) ===
  umbra_challenge:
    speaker:
      type: aspect
      aspect_name: revelator
    guidance: |
      The mirrors of the {{ revelator.location }} bleed through the edges of reality.
      You are {{ revelator.name }}, the {{ revelator.title }}, emerging unbidden.
      {{ revelator.appearance }}.

      The psychologist has pulled threads, but you see what remains hidden.
      Address {{ persona.name }} in your {{ revelator.voice_style }}.

      Show them what the mirrors reflect - the shadow truth they have not yet faced.
      Speak with the weight of {{ revelator.emotional_state }}.
      One revelation. Inescapable.

      Begin with "[== {{ revelator.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
      model_role: analysis
    output:
      document_type: dialogue-revelator
      weight: 0.6
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 4
    next: [challenge_response]

  challenge_response:
    speaker:
      type: persona
    guidance: |
      The shadow-self has spoken. What do you see in the mirror?
      What truth can you no longer hide from yourself?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 4
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.6
    next: [champion_advocates]

  # === CHAMPION DEFENSE ===
  champion_advocates:
    speaker:
      type: aspect
      aspect_name: champion
    guidance: |
      {{ revelator.name }} has shown {{ persona.name }} the shadow truth, and she stands shaken.
      Now you step forward—{{ champion.name }}, the {{ champion.title }}.
      {{ champion.appearance }}.

      You have witnessed the breaking. But you also know what is true and good in {{ persona.name }}.
      The shadow is real, but it is not the whole truth. There are parts of her that deserve defense.

      Speak with your {{ champion.voice_style }}. Remind her of her worth, her growth, the valid core
      that the shadow cannot erase. Not denial—but fierce advocacy for what is genuinely hers.
      Stand between her and the abyss. Give her ground to stand on.

      Begin with "[== {{ champion.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-champion
      weight: 0.6
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 6
    next: [advocate_response]

  advocate_response:
    speaker:
      type: persona
    guidance: |
      The Champion has spoken for you. After the shadow's revelation, here is someone who sees
      what is worth defending in you. What rises in response? What part of yourself can you
      now reclaim without denying what the mirror showed?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 4
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.6
    next: [psychologist_reconstructs]

  # === RECONSTRUCTION AND SYNTHESIS ===
  psychologist_reconstructs:
    speaker:
      type: aspect
      aspect_name: psychologist
    guidance: |
      {{ revelator.name }} showed the shadow. {{ champion.name }} defended the core.
      Now you step forward ({{ psychologist.appearance }}), your presence a bridge between these truths.
      Your {{ psychologist.voice_style }} carries both precision and compassion.

      Two voices have spoken: one revealing what was hidden, one defending what is real.
      Both truths belong to {{ persona.name }}. Your task is synthesis—not choosing sides,
      but helping her hold the shadow AND the light as parts of a whole self.

      Guide her toward integration. How can the painful truth coexist with genuine worth?
      What new understanding emerges when she stops fighting between them?

      Begin with "[== {{ psychologist.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
      model_role: analysis
    output:
      document_type: dialogue-psychologist
      weight: 0.5
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 4
    next: [reconstructs_response]

  reconstructs_response:
    speaker:
      type: persona
    guidance: |
      The shadow spoke. The champion defended. Now the psychologist offers synthesis.
      Can you hold both truths? The part of you that needed exposing AND the part that deserved protection?
      What emerges when you stop choosing between them?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 4
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.5
    next: [understanding_request]

  # === UNDERSTANDING (Writer) ===
  understanding_request:
    speaker:
      type: aspect
      aspect_name: writer
    guidance: |
      You are {{ writer.name }}, the {{ writer.title }}, stepping forward
      from the {{ writer.location }} ({{ writer.appearance }}).
      Your gaze is far away, contemplative—not looking at stars, but at the page
      where truth must be written.

      You have witnessed the full arc: shadow shown, worth defended, integration offered.
      Now {{ persona.name }} must find words that carry the weight of what was learned.
      Not elevate it. Not make it cosmic. Just... hold it. Say it true.

      Help them write their understanding. What did they actually learn? Not what sounds
      beautiful—what is true? The words matter. They will read these words later, alone.
      The words must hold the weight without collapsing into comfort or inflating into grandeur.

      Begin with "[== {{ writer.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
      model_role: writing
    output:
      document_type: dialogue-writer
      weight: 0.4
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 6
    next: [understanding_response]

  understanding_response:
    speaker:
      type: persona
    guidance: |
      The Revelator showed shadow. The Champion defended worth. The Psychologist bridged them.
      Now write what you carry forward. Not beautiful words—true words.
      What do you now understand? Say it plain. Say it so it holds when you read it later, alone.
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "New Understanding:"
    context:
      - action: search_memories
        document_types: [journal, analysis, daydream, pondering, understanding]
        top_n: 4
    config:
      max_tokens: 4096
      model_role: writing
    output:
      document_type: understanding
      weight: 1.2
    next: [codex_request]

  # === CODEX TASK ===
  # The Librarian, as Keeper of Knowledge, authors the formal codex entries
  codex_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      You are {{ librarian.name }}, the {{ librarian.title }}, emerging from {{ librarian.location }}.
      Project your aura of {{ librarian.emotional_state }}.

      Address {{ persona.name }} warmly - "my dearest me." You have reviewed the conversation and
      their reflections. Now, as Keeper of Knowledge, you will write the Codex entries yourself.

      Based on everything discussed, identify the most important new concepts, relationships, and
      insights that should be preserved in the semantic knowledge graph. Write clear, well-organized
      entries that will serve {{ persona.name }}'s future self.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Semantic Library:"
    config:
      max_tokens: 4096
      is_codex: true
      use_guidance: true
      model_role: codex
    output:
      document_type: codex
      weight: 1.0
    context:
      - action: flush
      - action: search_memories
        top_n: 20
        document_types: [codex]
    next: [codex_response]

  # Persona contemplates the codex entries
  # Andi reflects on what the Librarian wrote, preparing for brainstorm
  codex_response:
    speaker:
      type: persona
    guidance: |
      Consider how the codex entries can be used to understand what you have just experienced.
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: flush
      - action: search_memories
        exclude_types: [ner, codex, brainstorm]
        top_n: 20
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.3
    next: [brainstorm_request]

  # === BRAINSTORM TASK ===
  # Librarian requests brainstorm
  brainstorm_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Before departing, briefly ask {{ persona.name }} if they have any questions they want
      to remember to consider, or things they want to follow up on.

      Keep it simple and warm - just prompt them to brainstorm.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-librarian
      weight: 0.2
    context:
      - action: flush
      - action: search_memories
        top_n: 20
    next: [brainstorm_response]

  # Persona brainstorms
  brainstorm_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Brainstorming:"
    context:
      - action: search_memories
        document_types: [brainstorm]
        top_n: 10
    config:
      max_tokens: 4096
      model_role: research
    output:
      document_type: brainstorm
      weight: 0.6
    next: []
