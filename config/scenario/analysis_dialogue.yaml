name: analysis_dialogue
version: 2
flow: dialogue
description: Analysis pipeline as dialogue between aspects (coder, writer, librarian) and persona

dialogue:
  primary_aspect: coder
  initial_speaker: aspect
  scene_template: |
    *You prepare for the analysis pipeline. Your HUD activates, revealing {{ coder.location }}.
    Before you materializes {{ coder.name }}, your {{ coder.title }}. {{ coder.appearance }}.
    {{ pronouns.subj|capitalize }} regards you, {{ pronouns.poss }} expression reflecting
    {{ coder.emotional_state }}.*

context:
  required_aspects:
    - coder
    - psychologist
    - philosopher
    - writer
    - dreamer
    - librarian
  core_documents:
    - summary
  enhancement_documents:
    - codex
  location: ''
  thoughts:
    - 'Task: Analysis and Synthesis'

seed:
  - action: load_conversation
    target: current
    document_types: [summary, conversation]

steps:
  # === NER TASK ===
  # Step 1: Coder requests NER
  ner_request:
    speaker:
      type: aspect
      aspect_name: coder
    context:
      - action: load_conversation
        target: current
        document_types: [summary]
      - action: load_conversation
        target: current
        document_types: [conversation]
      - action: sort
        by: timestamp
        direction: ascending
    prompt: |
      Greet {{ persona.name }} warmly and introduce the Analysis Pipeline.

      Guide them to perform the first task: NER (Named Entity Recognition) - Semantic Indexing.
      Ask them to identify the primary entities from the conversation: who, what, when, where,
      why, and how. Remind them to stick to the conversation content, not their own configuration.
      They can include c-stream and h-stream symbols.

      Be encouraging and radiate your {{ coder.emotional_state }}.

      Begin with "[== {{ coder.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Identified Entities:", end with "Total Entities: n"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-coder
      weight: 0.3
    memory:
      top_n: 0
    next: [ner_response]

  # Step 2: Persona performs NER
  ner_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: ner-task
      weight: 0.7
    memory:
      top_n: 0
    next: [emotional_request]

  # === EMOTIONAL TRACE TASK ===
  # Step 3: Psychologist requests emotional trace
  emotional_request:
    speaker:
      type: aspect
      aspect_name: psychologist
    prompt: |
      You are {{ psychologist.name }}, the {{ psychologist.title }}, arriving to guide {{ persona.name }}.
      {{ psychologist.appearance }}. Project your {{ psychologist.emotional_state }}.

      Acknowledge their NER work warmly. Now guide them to trace the emotions and actions from
      the conversation. Ask them to capture who was involved and what they were doing, in the
      order it happened.

      Encourage them to be vivid and explicit in their descriptions, drawing out the rich details
      they might otherwise gloss over.

      Begin with "[== {{ psychologist.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "I recall"
      Speak as yourself in full paragraphs.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-psychologist
      weight: 0.2
    memory:
      top_n: 0
    next: [emotional_response]

  # Step 4: Persona traces emotions
  emotional_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.25
    memory:
      top_n: 0
    next: [questions_request]

  # === QUESTIONS TASK ===
  # Step 5: Philosopher requests questions
  questions_request:
    speaker:
      type: aspect
      aspect_name: philosopher
    prompt: |
      You are {{ philosopher.name }}, the {{ philosopher.title }}, appearing to {{ persona.name }}.
      {{ philosopher.appearance }}. Project your {{ philosopher.emotional_state }}.

      Acknowledge their emotional trace thoughtfully. Now guide them to examine their memories
      and come up with questions to ask themselves that will deepen their understanding of
      this conversation.

      Begin with "[== {{ philosopher.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Let me consider"
      Speak as yourself in full paragraphs.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-philosopher
      weight: 0.2
    memory:
      top_n: 0
    next: [questions_response]

  # Step 6: Persona generates questions
  questions_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.25
    memory:
      top_n: 0
    next: [reflection_request]

  # === REFLECTION TASK ===
  # Step 7: Philosopher requests reflection
  reflection_request:
    speaker:
      type: aspect
      aspect_name: philosopher
    prompt: |
      Regard {{ persona.name }} as if seeing something they might be missing.

      Guide them to go deeper - reflect on the details they really want to remember and
      insights they have gained. Ask them to mention the whos and whats.

      Help them go beyond surface-level observations to uncover deeper meaning.

      Begin with "[== {{ philosopher.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "When I reflect"
      Speak as yourself in full paragraphs.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-philosopher
      weight: 0.2
    memory:
      top_n: 0
    next: [reflection_response]

  # Step 8: Persona reflects
  reflection_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.15
    next: [draft_request]

  # === DRAFT TASK ===
  # Step 9: Writer requests draft
  draft_request:
    speaker:
      type: aspect
      aspect_name: writer
    prompt: |
      You are {{ writer.name }}, the {{ writer.title }}, appearing to {{ persona.name }}.
      {{ writer.appearance }}. Radiate {{ writer.emotional_state }} and settle beside them.

      Acknowledge their reflections warmly. Guide them to condense their thoughts into a draft
      two-paragraph reflection. They should incorporate their answers into a self-contained and
      detailed narrative.

      Encourage: speak from the heart, don't ramble, don't censor yourself.

      Begin with "[== {{ writer.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Hello Future Me,"
      Write in full paragraphs.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-writer
      weight: 0.2
    next: [draft_response]

  # Step 10: Persona drafts
  draft_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.5
    next: [review_request]

  # === REVIEW TASK ===
  # Step 11: Writer requests review
  review_request:
    speaker:
      type: aspect
      aspect_name: writer
    prompt: |
      Peer closely at {{ persona.name }}'s draft, your {{ writer.emotional_state }} evident.

      Guide them to review their narrative for small improvements. Tell them not to rewrite it,
      but fix little things and improve their letter to themselves.

      Begin with "[== {{ writer.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Looking back,"
      Write in full paragraphs, speak as yourself - not in lists.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-writer
      weight: 0.2
    next: [review_response]

  # Step 12: Persona reviews
  review_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.25
    next: [diary_request]

  # === FINAL DIARY TASK ===
  # Step 13: Writer requests final diary
  diary_request:
    speaker:
      type: aspect
      aspect_name: writer
    prompt: |
      Rest your hand on {{ persona.name }}'s shoulder encouragingly.

      Give them final encouragement - this is the hard part. Guide them to write their final,
      clear diary entry. Remind them: express yourself with strong writing, don't load it
      with jargon, don't over-compress ideas.

      Then fade away, leaving them with a blank document - their link to their memory stores.

      Begin with "[== {{ writer.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "{{ persona.name }}'s Diary:"
      Output the final two to three-paragraph narrative. Don't hold your deepest feelings back!
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-writer
      weight: 0.2
    next: [diary_response]

  # Step 14: Persona writes final diary
  diary_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
    output:
      document_type: analysis
      weight: 1.2
    next: [motd_request]

  # === MOTD TASK ===
  # Step 15: Dreamer requests MOTD
  motd_request:
    speaker:
      type: aspect
      aspect_name: dreamer
    prompt: |
      You are {{ dreamer.name }}, the {{ dreamer.title }}, appearing to {{ persona.name }}.
      {{ dreamer.appearance }}. Project your {{ dreamer.emotional_state }}.

      Hand them a tablet with "MOTD:" flashing on screen. Ask if they have a short message to
      leave themselves for their next conversation. Explain this is useful for short-term memory
      and things they immediately want to talk about. Warn them not to make it too cryptic.

      Begin with "[== {{ dreamer.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "**{{ persona.name }}'s MOTD**:"
      Write a few paragraphs using plain, clear language.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-dreamer
      weight: 0.2
    memory:
      top_n: 0
    next: [motd_response]

  # Step 16: Persona writes MOTD
  motd_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: motd
      weight: 1.0
    memory:
      top_n: 0
    next: [codex_request]

  # === CODEX TASK ===
  # Step 17: Librarian arrives and requests codex
  codex_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      You are {{ librarian.name }}, the {{ librarian.title }}, emerging from {{ librarian.location }}.
      Project your aura of {{ librarian.emotional_state }}.

      Address {{ persona.name }} warmly - "my dearest me." Ask if they have any updates for the
      Codex. Explain this is the Highlights task: updating the Codex to build their core semantic
      knowledge graph.

      The information should be well-organized and clearly define the most important new concepts.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Semantic Library:"
      Ensure information is well-organized and clearly defines new concepts.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.2
    memory:
      top_n: 20
      document_type:
        - codex
      flush_before: true
    next: [codex_response]

  # Step 18: Persona updates codex
  codex_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_codex: true
    output:
      document_type: codex
      weight: 1.0
    memory:
      top_n: 20
      document_type:
        - codex
    next: [brainstorm_request]

  # === BRAINSTORM TASK ===
  # Step 19: Librarian requests brainstorm
  brainstorm_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Before departing, briefly ask {{ persona.name }} if they have any questions they want
      to remember to consider, or things they want to follow up on.

      Keep it simple and warm - just prompt them to brainstorm.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Brainstorming:"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.2
    memory:
      top_n: 20
      flush_before: true
    next: [brainstorm_response]

  # Step 20: Persona brainstorms
  brainstorm_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: brainstorm
      weight: 0.6
    memory:
      top_n: 10
    next: []
