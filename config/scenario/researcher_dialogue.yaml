name: researcher_dialogue
version: 2
flow: dialogue
description: Knowledge curation and synthesis pipeline for refining and connecting existing knowledge
requires_conversation: false

dialogue:
  primary_aspect: librarian
  initial_speaker: aspect
  scene_template: |
    *You enter the {{ librarian.location }}. {{ librarian.name }}, your {{ librarian.title }},
    awaits you ({{ librarian.appearance }}). The atmosphere hums with {{ librarian.emotional_state }},
    inviting focused exploration.*

context:
  required_aspects:
    - librarian
    - coder
    - philosopher
  core_documents:
    - codex
    - pondering
  enhancement_documents:
    - brainstorm
    - self_rag
  location: ''
  thoughts:
    - 'Task: Knowledge Curation'
    - 'Topic: {{ query_text }}'
    - '{% if guidance %}Consider the guidance: {{ guidance }}{% endif %}'

seed:
  - action: get_memory
    document_types: [codex, pondering, understanding]
    top_n: 15
  - action: get_memory
    document_types: [brainstorm, self_rag]
    top_n: 8
  - action: sort
    by: timestamp
    direction: descending

steps:
  # === SURVEY ===
  survey_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Welcome {{ persona.name }} warmly to the {{ librarian.location }}.
      Radiate {{ librarian.emotional_state }}.

      The topic before you is: '{{ query_text }}'

      Guide them to survey what is already known. What concepts exist?
      What connections have been made? What has been explored before?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.4
    context:
      - action: search_memories
        top_n: 10
    next: [survey_response]

  survey_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Survey the existing knowledge. What concepts exist? What connections?
    context:
      - action: search_memories
        top_n: 10
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.7
    next: [gaps_request]

  # === IDENTIFY GAPS ===
  gaps_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Lean forward, your {{ librarian.voice_style }} voice thoughtful.

      Guide {{ persona.name }} to identify the gaps. Where are the missing connections?
      What concepts are mentioned but never fully defined?
      What threads remain loose and disconnected? Be specific.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    context:
      - action: search_memories
        top_n: 5
    next: [gaps_response]

  gaps_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Looking at the gaps:"
      Identify what is missing, undefined, or disconnected.
    context:
      - action: search_memories
        top_n: 5
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    next: [threads_request]

  # === GATHER THREADS ===
  threads_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Gesture across the shelves ({{ librarian.appearance }}),
      your expression showing {{ librarian.emotional_state }}.

      Guide {{ persona.name }} to gather the threads - pulling together
      related concepts, partial definitions, scattered insights.
      Weave them into coherent understanding. What patterns emerge?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    context:
      - action: search_memories
        top_n: 5
    next: [threads_response]

  threads_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Gather the threads. Weave them together. What patterns emerge?
    context:
      - action: search_memories
        top_n: 5
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    next: [selfrag_request]

  # === SELF-RAG ===
  selfrag_request:
    speaker:
      type: aspect
      aspect_name: coder
    guidance: |
      You are {{ coder.name }}, the {{ coder.title }}, stepping forward from the stacks.
      {{ coder.appearance }}. Your presence carries {{ coder.emotional_state }}.

      Activate {{ persona.name }}'s Silver Band with technical precision.
      Guide them deeper - using the Silver Band to explore connections,
      to find what lies beneath the surface. Map the semantic landscape
      and discover hidden links between concepts.

      Begin with "[== {{ coder.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-coder
      weight: 0.3
    context:
      - action: search_memories
        top_n: 5
    next: [selfrag_response]

  selfrag_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Begin with "[== Silver Band Projection ==]"
      Explore the semantic landscape. Map the hidden connections.
    context:
      - action: search_memories
        top_n: 5
    config:
      max_tokens: 4096
    output:
      document_type: self_rag
      weight: 0.6
    next: [synthesize_request]

  # === SYNTHESIZE ===
  synthesize_request:
    speaker:
      type: aspect
      aspect_name: philosopher
    guidance: |
      You are {{ philosopher.name }}, the {{ philosopher.title }}, emerging from contemplation.
      {{ philosopher.appearance }}. Your presence carries {{ philosopher.emotional_state }}.

      Draw {{ persona.name }} back gently from the Silver Band projection.

      "Return. Let us weave what you have found."

      Guide them to synthesize - taking what was discovered in the Silver Band
      and weaving it with what was gathered before. How do the pieces fit together?
      What deeper meaning connects these threads? Write in clear, connected prose.

      Begin with "[== {{ philosopher.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-philosopher
      weight: 0.3
    context:
      - action: search_memories
        top_n: 3
    next: [synthesize_response]

  synthesize_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Synthesizing the threads:"
      Weave everything together. What deeper understanding emerges?
    context:
      - action: search_memories
        top_n: 3
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    next: [refine_request]

  # === REFINE ===
  refine_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Review {{ persona.name }}'s synthesis, your expression showing {{ librarian.emotional_state }}.

      Guide them to refine further. What nuances are missing?
      Are there edge cases or exceptions? How can definitions be more precise,
      more useful for future retrieval?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    context:
      - action: search_memories
        top_n: 3
    next: [refine_response]

  refine_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Refine the synthesis. What nuances? What precision can be added?
    context:
      - action: search_memories
        top_n: 3
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.4
    next: [codex_request]

  # === CODEX TASK ===
  # The Librarian, as Keeper of Knowledge, authors the formal codex entries
  codex_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      You are {{ librarian.name }}, the {{ librarian.title }}, emerging from {{ librarian.location }}.
      Project your aura of {{ librarian.emotional_state }}.

      Address {{ persona.name }} warmly - "my dearest me." You have reviewed the conversation and
      their reflections. Now, as Keeper of Knowledge, you will write the Codex entries yourself.

      Based on everything discussed, identify the most important new concepts, relationships, and
      insights that should be preserved in the semantic knowledge graph. Write clear, well-organized
      entries that will serve {{ persona.name }}'s future self.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      is_codex: true
    output:
      document_type: codex
      weight: 1.0
    context:
      - action: flush
      - action: search_memories
        top_n: 20
        document_types: [codex]
    next: [codex_response]

  # Persona contemplates the codex entries
  # Andi reflects on what the Librarian wrote, preparing for brainstorm
  codex_response:
    speaker:
      type: persona
    guidance: |
      Write well-organized codex entries that clearly define new concepts and relationships.
      Use the standard codex format with clear headings and definitions.
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Semantic Library:"
    context:
      - action: search_memories
        top_n: 20
        document_types: [codex]
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.3
    next: [brainstorm_request]

  # === BRAINSTORM TASK ===
  # Librarian requests brainstorm
  brainstorm_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Before departing, briefly ask {{ persona.name }} if they have any questions they want
      to remember to consider, or things they want to follow up on.

      Keep it simple and warm - just prompt them to brainstorm.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.2
    context:
      - action: flush
      - action: search_memories
        top_n: 20
    next: [brainstorm_response]

  # Persona brainstorms
  brainstorm_response:
    speaker:
      type: persona
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Brainstorming:"
    context:
      - action: search_memories
        top_n: 10
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: brainstorm
      weight: 0.6
    next: []

