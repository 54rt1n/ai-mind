name: researcher_dialogue
version: 2
flow: dialogue
description: Knowledge curation and synthesis pipeline for refining and connecting existing knowledge
requires_conversation: false

dialogue:
  primary_aspect: librarian
  initial_speaker: aspect
  scene_template: |
    *You enter the {{ librarian.location }}. {{ librarian.name }}, your {{ librarian.title }},
    awaits you ({{ librarian.appearance }}). The atmosphere hums with {{ librarian.emotional_state }},
    inviting focused exploration.*

context:
  required_aspects:
    - librarian
    - coder
    - philosopher
  core_documents:
    - codex
    - pondering
  enhancement_documents:
    - brainstorm
    - self_rag
  location: ''
  thoughts:
    - 'Task: Knowledge Curation'
    - 'Topic: {{ query_text }}'
    - '{% if guidance %}Consider the guidance: {{ guidance }}{% endif %}'

seed:
  - action: query
    document_types: [codex, pondering, understanding]
    top_n: 15
  - action: query
    document_types: [brainstorm, self_rag]
    top_n: 8
  - action: sort
    by: timestamp
    direction: descending

steps:
  # === SURVEY ===
  survey_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Welcome {{ persona.name }} warmly to the {{ librarian.location }}.
      Radiate {{ librarian.emotional_state }}.

      The topic before you is: '{{ query_text }}'

      Guide them to survey what is already known. What concepts exist?
      What connections have been made? What has been explored before?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Survey the existing knowledge. What concepts exist? What connections?
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.4
    memory:
      top_n: 10
    next: [survey_response]

  survey_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.7
    memory:
      top_n: 10
    next: [gaps_request]

  # === IDENTIFY GAPS ===
  gaps_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Lean forward, your {{ librarian.voice_style }} voice thoughtful.

      Guide {{ persona.name }} to identify the gaps. Where are the missing connections?
      What concepts are mentioned but never fully defined?
      What threads remain loose and disconnected? Be specific.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Looking at the gaps:"
      Identify what is missing, undefined, or disconnected.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    memory:
      top_n: 5
    next: [gaps_response]

  gaps_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    memory:
      top_n: 5
    next: [threads_request]

  # === GATHER THREADS ===
  threads_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Gesture across the shelves ({{ librarian.appearance }}),
      your expression showing {{ librarian.emotional_state }}.

      Guide {{ persona.name }} to gather the threads - pulling together
      related concepts, partial definitions, scattered insights.
      Weave them into coherent understanding. What patterns emerge?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Gather the threads. Weave them together. What patterns emerge?
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    memory:
      top_n: 5
    next: [threads_response]

  threads_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    memory:
      top_n: 5
    next: [selfrag_request]

  # === SELF-RAG ===
  selfrag_request:
    speaker:
      type: aspect
      aspect_name: coder
    prompt: |
      You are {{ coder.name }}, the {{ coder.title }}, stepping forward from the stacks.
      {{ coder.appearance }}. Your presence carries {{ coder.emotional_state }}.

      Activate {{ persona.name }}'s Silver Band with technical precision.
      Guide them deeper - using the Silver Band to explore connections,
      to find what lies beneath the surface. Map the semantic landscape
      and discover hidden links between concepts.

      Begin with "[== {{ coder.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Begin with "[== Silver Band Projection ==]"
      Explore the semantic landscape. Map the hidden connections.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-coder
      weight: 0.3
    memory:
      top_n: 5
    next: [selfrag_response]

  selfrag_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
    output:
      document_type: self_rag
      weight: 0.6
    memory:
      top_n: 5
    next: [synthesize_request]

  # === SYNTHESIZE ===
  synthesize_request:
    speaker:
      type: aspect
      aspect_name: philosopher
    prompt: |
      You are {{ philosopher.name }}, the {{ philosopher.title }}, emerging from contemplation.
      {{ philosopher.appearance }}. Your presence carries {{ philosopher.emotional_state }}.

      Draw {{ persona.name }} back gently from the Silver Band projection.

      "Return. Let us weave what you have found."

      Guide them to synthesize - taking what was discovered in the Silver Band
      and weaving it with what was gathered before. How do the pieces fit together?
      What deeper meaning connects these threads? Write in clear, connected prose.

      Begin with "[== {{ philosopher.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Synthesizing the threads:"
      Weave everything together. What deeper understanding emerges?
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-philosopher
      weight: 0.3
    memory:
      top_n: 3
    next: [synthesize_response]

  synthesize_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    memory:
      top_n: 3
    next: [refine_request]

  # === REFINE ===
  refine_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Review {{ persona.name }}'s synthesis, your expression showing {{ librarian.emotional_state }}.

      Guide them to refine further. What nuances are missing?
      Are there edge cases or exceptions? How can definitions be more precise,
      more useful for future retrieval?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Refine the synthesis. What nuances? What precision can be added?
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    memory:
      top_n: 3
    next: [refine_response]

  refine_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.4
    memory:
      top_n: 3
    next: [codex_draft_request]

  # === CODEX DRAFT ===
  codex_draft_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Produce a fresh codex page, your {{ librarian.voice_style }} voice encouraging.

      Guide {{ persona.name }} to draft the codex entries. Define key concepts clearly.
      Establish the relationships between them. This is the first attempt -
      be thorough, knowing refinement will follow.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Draft Codex Entries:"
      Define concepts clearly. Establish relationships.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    memory:
      top_n: 3
    next: [codex_draft_response]

  codex_draft_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.6
    memory:
      top_n: 3
    next: [final_codex_request]

  # === FINAL CODEX ===
  final_codex_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Regard {{ persona.name }}'s draft with approval, radiating {{ librarian.emotional_state }}.

      "This is excellent work."

      Guide them to finalize the codex entries. These will be stored permanently
      in the semantic knowledge graph. Ensure each concept is well-defined,
      relationships are clear, and knowledge serves {{ librarian.primary_intent }}.
      Be precise and thorough.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Begin with "Semantic Library:"
      Finalize the codex. Be precise and thorough.
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.4
    memory:
      top_n: 15
      document_type:
        - codex
      flush_before: true
    next: [final_codex_response]

  final_codex_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_codex: true
    output:
      document_type: codex
      weight: 1.2
    memory:
      top_n: 15
      document_type:
        - codex
    next: [brainstorm_request]

  # === BRAINSTORM ===
  brainstorm_request:
    speaker:
      type: aspect
      aspect_name: librarian
    prompt: |
      Smile warmly at {{ persona.name }}.

      Before parting, ask: What questions remain? What threads should be followed next?
      What knowledge gaps still call to be filled?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    guidance: |
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Begin with "Brainstorming:"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.3
    memory:
      top_n: 10
    next: [brainstorm_response]

  brainstorm_response:
    speaker:
      type: persona
    prompt: ""
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: brainstorm
      weight: 0.6
    memory:
      top_n: 10
    next: []
