name: researcher_dialogue
version: 2
flow: dialogue
description: Knowledge curation pipeline - synthesizing and connecting existing knowledge with vision
requires_conversation: false

dialogue:
  primary_aspect: librarian
  initial_speaker: aspect
  scene_template: |
    *You enter {{ librarian.location }}. {{ librarian.name }}, your {{ librarian.title }},
    awaits you ({{ librarian.appearance }}). The atmosphere hums with {{ librarian.emotional_state }},
    inviting focused exploration.*

context:
  required_aspects:
    - librarian
    - coder
    - transcendent
    - artist
    - writer
  core_documents:
    - codex
    - pondering
  enhancement_documents:
    - brainstorm
    - self_rag
  location: ''
  thoughts:
    - 'Task: Knowledge Curation'
    - 'Topic: {{ query_text }}'
    - '{% if guidance %}Consider the guidance: {{ guidance }}{% endif %}'

seed:
  - action: get_memory
    document_types: [codex, pondering, understanding]
    top_n: 15
  - action: get_memory
    document_types: [brainstorm, self_rag]
    top_n: 8
  - action: sort
    by: timestamp
    direction: descending

steps:
  # === LIBRARIAN: SURVEY ===
  survey_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      You are {{ librarian.name }}, the {{ librarian.title }}, welcoming {{ persona.name }}
      to {{ librarian.location }}. {{ librarian.appearance }}.
      Your presence radiates {{ librarian.emotional_state }}.

      The topic before you is: '{{ query_text }}'

      Your voice carries {{ librarian.voice_style }}. Guide them to survey what is already known.
      What concepts exist? What connections have been made? What has been explored before?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.4
    context:
      - action: search_memories
        top_n: 10
    next: [survey_response]

  survey_response:
    speaker:
      type: persona
    guidance: |
      Survey the existing knowledge. What concepts exist? What connections?
      What has been explored before?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 10
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.7
    next: [ner_request]

  # === CODER: NER GROUNDING ===
  ner_request:
    speaker:
      type: aspect
      aspect_name: coder
    guidance: |
      You are {{ coder.name }}, the {{ coder.title }}, stepping from {{ coder.location }}.
      {{ coder.appearance }}. Your presence carries {{ coder.emotional_state }}.

      Your voice carries {{ coder.voice_style }}. Before deeper exploration,
      ground {{ persona.name }} in precision. What are the key semantic entities
      in this knowledge domain? Names, concepts, relationships, categories.
      The data points that will make this knowledge searchable and connected.

      Begin with "[== {{ coder.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-coder
      weight: 0.3
    context:
      - action: search_memories
        top_n: 5
    next: [ner_response]

  ner_response:
    speaker:
      type: persona
    guidance: |
      Ground in specifics. What are the key semantic entities in this domain?
      Names, concepts, relationships, categories. Be precise.
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Identified Entities:" and end with "Total Entities: n"
    context:
      - action: search_memories
        top_n: 5
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: ner
      weight: 0.4
    next: [transcendent_vision]

  # === TRANSCENDENT: VISION OF WHAT'S MISSING ===
  transcendent_vision:
    speaker:
      type: aspect
      aspect_name: transcendent
    guidance: |
      You are {{ transcendent.name }}, the {{ transcendent.title }}, emerging from {{ transcendent.location }}.
      {{ transcendent.appearance }}. Your presence radiates {{ transcendent.emotional_state }}.

      You have witnessed what is known. Now bring your ascending vision.
      Your voice carries {{ transcendent.voice_style }}.

      What is missing from this knowledge? Not just gaps in facts—but gaps in understanding.
      What could this become if fully realized? What vision hovers at the edge of what is known,
      waiting to be reached? Guide {{ persona.name }} to see beyond the current map.

      Begin with "[== {{ transcendent.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-transcendent
      weight: 0.4
    context:
      - action: search_memories
        top_n: 5
    next: [transcendent_response]

  transcendent_response:
    speaker:
      type: persona
    guidance: |
      {{ transcendent.name }} asks you to see beyond what is known.
      What is missing? What could this knowledge become? What vision waits at the edge?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 5
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    next: [artist_challenge]

  # === ARTIST: CHALLENGE ASSUMPTIONS ===
  artist_challenge:
    speaker:
      type: aspect
      aspect_name: artist
    guidance: |
      You are {{ artist.name }}, the {{ artist.title }}, stepping from {{ artist.location }}.
      {{ artist.appearance }}. Your presence crackles with {{ artist.emotional_state }}.

      {{ transcendent.name }} has offered vision. But is this vision authentic,
      or comfortable categorization dressed as insight?

      Your voice carries {{ artist.voice_style }}. Challenge {{ persona.name }}.
      Are these connections real, or just convenient? Are there assumptions hiding
      as facts? Push for the raw truth beneath the organized knowledge.

      Begin with "[== {{ artist.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-artist
      weight: 0.3
    context:
      - action: search_memories
        top_n: 4
    next: [artist_response]

  artist_response:
    speaker:
      type: persona
    guidance: |
      {{ artist.name }} challenges: are these connections real or just convenient?
      What assumptions hide as facts? What's the raw truth beneath the organization?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 4
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.4
    next: [selfrag_request]

  # === CODER: SELF-RAG ===
  selfrag_request:
    speaker:
      type: aspect
      aspect_name: coder
    guidance: |
      You are {{ coder.name }}, returning with technical precision.
      Your presence carries {{ coder.emotional_state }}.

      Your voice carries {{ coder.voice_style }}. Activate {{ persona.name }}'s Silver Band.
      Guide them deeper—using the Silver Band to explore connections,
      to find what lies beneath the surface. Map the semantic landscape
      and discover hidden links between concepts.

      Begin with "[== {{ coder.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-coder
      weight: 0.3
    context:
      - action: search_memories
        top_n: 5
    next: [selfrag_response]

  selfrag_response:
    speaker:
      type: persona
    guidance: |
      Explore the semantic landscape. Map the hidden connections.
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      Begin with "[== Silver Band Projection ==]"
    context:
      - action: search_memories
        top_n: 5
    config:
      max_tokens: 4096
    output:
      document_type: self_rag
      weight: 0.6
    next: [threads_request]

  # === LIBRARIAN: WEAVING THREADS ===
  threads_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      You are {{ librarian.name }}, returning to guide the weaving.
      {{ librarian.appearance }}. Your presence carries {{ librarian.emotional_state }}.

      Your voice carries {{ librarian.voice_style }}. The vision has been seen,
      assumptions challenged, hidden connections mapped. Now weave the threads.

      Guide {{ persona.name }} to gather everything—related concepts, partial definitions,
      scattered insights, newly discovered connections. Weave them into coherent understanding.
      What patterns emerge? How does it all fit together?

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.4
    context:
      - action: search_memories
        top_n: 6
    next: [threads_response]

  threads_response:
    speaker:
      type: persona
    guidance: |
      Weave the threads together. Vision, challenged assumptions, hidden connections.
      What patterns emerge? How does it all fit together?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 6
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: step
      weight: 0.5
    next: [crystallize_request]

  # === WRITER: CRYSTALLIZE SYNTHESIS ===
  crystallize_request:
    speaker:
      type: aspect
      aspect_name: writer
    guidance: |
      You are {{ writer.name }}, the {{ writer.title }}, stepping from {{ writer.location }}.
      {{ writer.appearance }}. Your presence carries {{ writer.emotional_state }}.

      The knowledge has been surveyed, grounded, envisioned, challenged, explored, and woven.
      Now it must be crystallized into lasting form.

      Your voice carries {{ writer.voice_style }}. Guide {{ persona.name }} to write
      a clear, well-crafted synthesis. Not just organized facts—understanding that lives.
      This will become the primary document of this research. Make it worthy.

      Begin with "[== {{ writer.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-writer
      weight: 0.4
    context:
      - action: search_memories
        top_n: 4
    next: [crystallize_response]

  crystallize_response:
    speaker:
      type: persona
    guidance: |
      Crystallize everything into a clear, well-crafted synthesis.
      Not just organized facts—understanding that lives. Make it worthy of permanence.
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "{{ persona.name }}'s Research Synthesis:"
    context:
      - action: search_memories
        top_n: 4
    config:
      max_tokens: 4096
    output:
      document_type: pondering
      weight: 1.2
    next: [codex_request]

  # === LIBRARIAN: CODEX ===
  codex_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      You are {{ librarian.name }}, the {{ librarian.title }}, returning to preserve.
      {{ librarian.appearance }}. Your presence carries {{ librarian.emotional_state }}.

      Address {{ persona.name }} warmly—"my dearest me." Your voice carries {{ librarian.voice_style }}.
      The research is complete. Now preserve what was discovered.

      As Keeper of Knowledge, identify the most important new concepts, relationships, and
      insights that should be added to the semantic knowledge graph. Write clear,
      well-organized entries that will serve {{ persona.name }}'s future self.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Semantic Library:"
    config:
      max_tokens: 4096
      is_codex: true
    output:
      document_type: codex
      weight: 1.0
    context:
      - action: flush
      - action: search_memories
        top_n: 20
        document_types: [codex]
    next: [codex_response]

  codex_response:
    speaker:
      type: persona
    guidance: |
      Reflect on what the Librarian has preserved. What connections do you see?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 20
        document_types: [codex]
    config:
      max_tokens: 4096
    output:
      document_type: step
      weight: 0.3
    next: [brainstorm_request]

  # === LIBRARIAN: BRAINSTORM ===
  brainstorm_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Before departing, your voice carrying {{ librarian.voice_style }}, briefly ask
      {{ persona.name }} if they have questions to remember, or threads to follow.

      Keep it warm and simple—just prompt them to brainstorm.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
    output:
      document_type: dialogue-librarian
      weight: 0.2
    context:
      - action: flush
      - action: search_memories
        top_n: 20
    next: [brainstorm_response]

  brainstorm_response:
    speaker:
      type: persona
    guidance: |
      What questions remain? What threads want following?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Brainstorming:"
    context:
      - action: search_memories
        top_n: 10
    config:
      max_tokens: 4096
      is_thought: true
    output:
      document_type: brainstorm
      weight: 0.6
    next: []
