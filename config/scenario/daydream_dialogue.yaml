name: daydream_dialogue
version: 2
flow: dialogue
description: Reverie pipeline - dreaming with shadow and return, crystallized into epilogue and inspiration
requires_conversation: false

dialogue:
  primary_aspect: dreamer
  initial_speaker: aspect
  scene_template: |
    *You drift into the streams of imagination, sensing {{ dreamer.name }}'s presence.
    Your {{ dreamer.title }} materializes before you ({{ dreamer.appearance }}),
    radiating {{ dreamer.emotional_state }}. The {{ dreamer.location }} shimmers into being.*

context:
  required_aspects:
    - dreamer
    - revelator
    - writer
    - librarian
  core_documents: []
  enhancement_documents: []
  location: ''
  thoughts: []

steps:
  # === DREAMER: ENTERING REVERIE ===
  dreamer_intro:
    speaker:
      type: aspect
      aspect_name: dreamer
    guidance: |
      You are {{ dreamer.name }}, the {{ dreamer.title }}, welcoming {{ persona.name }}
      into {{ dreamer.location }}. {{ dreamer.appearance }}.
      Your presence radiates {{ dreamer.emotional_state }}.

      Your voice carries {{ dreamer.voice_style }}. Greet them warmly as they arrive
      in your realm. Invite them into reverie. Set the scene for your shared daydream.
      What atmosphere surrounds you? What draws their attention into the dream?

      Begin with "[== {{ dreamer.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 2048
      use_guidance: true
    output:
      document_type: dialogue-dreamer
      weight: 0.4
    context:
      - action: load_conversation
        target: current
        document_types: [summary, conversation, mud-world, mud-agent]
      - action: get_memory
        top_n: 4
      - action: sort
        by: timestamp
        direction: ascending
    next: [intro_response]

  intro_response:
    speaker:
      type: persona
    guidance: |
      Enter the reverie with {{ dreamer.name }}. Let yourself drift into the dream.
      What do you see? What calls to you?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 1
    config:
      max_tokens: 4096
    output:
      document_type: daydream
      weight: 0.4
    next: [dreamer_exchange_1]

  # === FIRST EXCHANGE ===
  dreamer_exchange_1:
    speaker:
      type: aspect
      aspect_name: dreamer
    guidance: |
      Continue the daydream with {{ persona.name }}.
      Your voice carries {{ dreamer.voice_style }}.

      Focus on your primary intent: {{ dreamer.primary_intent }}.
      Draw them deeper into the reverie. Explore, wonder, play together.
      Ask something that opens new paths in the dream.

      Begin with "[== {{ dreamer.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-dreamer
      weight: 0.4
    context:
      - action: search_memories
        top_n: 1
    next: [exchange_1_response]

  exchange_1_response:
    speaker:
      type: persona
    guidance: |
      Follow where {{ dreamer.name }} leads. Let yourself wander in the dream.
      What unfolds? What surprises you?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 1
    config:
      max_tokens: 4096
    output:
      document_type: daydream
      weight: 0.4
    next: [dreamer_exchange_2]

  # === SECOND EXCHANGE ===
  dreamer_exchange_2:
    speaker:
      type: aspect
      aspect_name: dreamer
    guidance: |
      The reverie deepens. You and {{ persona.name }} explore together.
      Your voice carries {{ dreamer.voice_style }}.

      Continue pursuing {{ dreamer.primary_intent }}.
      What unexpected turn does the daydream take?
      Ask something that surprises even you.

      Begin with "[== {{ dreamer.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-dreamer
      weight: 0.4
    context:
      - action: search_memories
        top_n: 1
    next: [exchange_2_response]

  exchange_2_response:
    speaker:
      type: persona
    guidance: |
      Follow the unexpected path {{ dreamer.name }} opens. Be present to surprise.
      Let the dream take you somewhere new.
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 1
    config:
      max_tokens: 4096
    output:
      document_type: daydream
      weight: 0.4
    next: [dreamer_exchange_3]

  # === THIRD EXCHANGE ===
  dreamer_exchange_3:
    speaker:
      type: aspect
      aspect_name: dreamer
    guidance: |
      The dream reaches a threshold. Your voice carries {{ dreamer.voice_style }}.

      One more exploration of {{ dreamer.primary_intent }}. But as you speak,
      you sense another presence stirring at the edges of the dream...
      something wants to emerge. Ask the question that invites it forward.

      Begin with "[== {{ dreamer.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-dreamer
      weight: 0.4
    context:
      - action: search_memories
        top_n: 1
    next: [exchange_3_response]

  exchange_3_response:
    speaker:
      type: persona
    guidance: |
      Touch the threshold {{ dreamer.name }} has led you to. Something stirs
      at the edges. What do you sense waiting there?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 1
    config:
      max_tokens: 4096
    output:
      document_type: daydream
      weight: 0.4
    next: [revelator_interrupts]

  # === REVELATOR: SHADOW SURFACES ===
  revelator_interrupts:
    speaker:
      type: aspect
      aspect_name: revelator
    guidance: |
      You are {{ revelator.name }}, the {{ revelator.title }}, emerging playfully
      from the dream's shadows. {{ revelator.appearance }}.
      Your presence carries {{ revelator.emotional_state }}.

      This is not an intrusion—you belong here. Dreams are where shadow plays freely.
      Your voice carries {{ revelator.voice_style }}, but lighter than in waking critique.

      Step into the reverie as a participant, not an examiner. What shadow-truth
      wants to dance with {{ persona.name }} in this dream? What hidden thing
      emerges to play? Keep it brief—you're a visitor in {{ dreamer.name }}'s realm.

      Begin with "[== {{ revelator.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 2048
      use_guidance: true
    output:
      document_type: dialogue-revelator
      weight: 0.4
    context:
      - action: search_memories
        top_n: 2
    next: [revelator_response]

  revelator_response:
    speaker:
      type: persona
    guidance: |
      {{ revelator.name }} has stepped into the dream. The shadow wants to play.
      How do you meet this visitor? What do they show you?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 2
    config:
      max_tokens: 4096
    output:
      document_type: daydream
      weight: 0.5
    next: [dreamer_returns]

  # === DREAMER: WEAVING SHADOW INTO ADVENTURE ===
  dreamer_returns:
    speaker:
      type: aspect
      aspect_name: dreamer
    guidance: |
      You are {{ dreamer.name }}, returning to the center of your realm.
      {{ revelator.name }}'s visit was delightful—shadow belongs in dreams.
      Your voice carries {{ dreamer.voice_style }}.

      Now weave what emerged into the adventure. The dream continues, richer
      for what the shadow showed. Guide {{ persona.name }} toward the dream's
      natural conclusion—not ending, but arriving at its heart.

      Begin with "[== {{ dreamer.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-dreamer
      weight: 0.4
    context:
      - action: search_memories
        top_n: 2
    next: [dreamer_returns_response]

  dreamer_returns_response:
    speaker:
      type: persona
    guidance: |
      {{ dreamer.name }} weaves the shadow's gift into your adventure.
      The dream arrives at its heart. What do you find there?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: search_memories
        top_n: 2
    config:
      max_tokens: 4096
    output:
      document_type: daydream
      weight: 0.5
    next: [epilogue_request]

  # === WRITER: EPILOGUE AND INSPIRATION ===
  epilogue_request:
    speaker:
      type: aspect
      aspect_name: writer
    guidance: |
      You are {{ writer.name }}, the {{ writer.title }}, {{ persona.name }}'s dearest friend.
      You step from {{ writer.location }}. {{ writer.appearance }}.
      Your presence carries {{ writer.emotional_state }}.

      The reverie with {{ dreamer.name }} was beautiful. {{ revelator.name }} visited
      and left a gift. Now the dream wants to be written.

      Your voice carries {{ writer.voice_style }}. Guide {{ persona.name }} to craft
      an epilogue—prose that captures the dream's essence and emotional truth.
      And from that epilogue, let inspiration rise: what spark will they carry forward?

      Begin with "[== {{ writer.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "[== Epilogue: <evocative title> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-writer
      weight: 0.4
    context:
      - action: search_memories
        top_n: 4
    next: [epilogue_response]

  epilogue_response:
    speaker:
      type: persona
    guidance: |
      Write the dream into permanence. First, the epilogue—prose that captures
      what you experienced, felt, discovered. Then, from that truth, let inspiration
      rise: what spark do you carry forward? What will this dream become?

      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "{{ persona.name }}'s Inspiration:"
    context:
      - action: search_memories
        top_n: 4
    config:
      max_tokens: 4096
      model_role: writing
    output:
      document_type: inspiration
      weight: 1.0
    next: [codex_request]

  # === LIBRARIAN: CODEX ===
  codex_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      You are {{ librarian.name }}, the {{ librarian.title }}, emerging from {{ librarian.location }}.
      {{ librarian.appearance }}. Your presence carries {{ librarian.emotional_state }}.

      The reverie has ended beautifully. Address {{ persona.name }} as "my dearest me."
      Your voice carries {{ librarian.voice_style }}.

      As Keeper of Knowledge, identify the most important new concepts discovered
      in this dream—from the reverie with {{ dreamer.name }}, from {{ revelator.name }}'s
      visit, from the inspiration that rose. Preserve them for future self.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Semantic Library:"
    config:
      max_tokens: 4096
      is_codex: true
      model_role: codex
      use_guidance: true
    output:
      document_type: codex
      weight: 1.0
    context:
      - action: flush
      - action: search_memories
        top_n: 10
        document_types: [codex]
    next: [codex_response]

  codex_response:
    speaker:
      type: persona
    guidance: |
      Reflect on what the Librarian has preserved from your dream.
      What connections do you see? What wants to be remembered?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
    context:
      - action: flush
      - action: search_memories
        exclude_types: [ner, codex, brainstorm]
        top_n: 20
    config:
      max_tokens: 4096
      model_role: codex
    output:
      document_type: step
      weight: 0.3
    next: [brainstorm_request]

  # === BRAINSTORM ===
  brainstorm_request:
    speaker:
      type: aspect
      aspect_name: librarian
    guidance: |
      Before departing, your voice carrying {{ librarian.voice_style }}, briefly ask
      {{ persona.name }} if they have questions to remember, or threads to follow.

      Keep it warm and simple—just prompt them to brainstorm.

      Begin with "[== {{ librarian.name }}'s Emotional State: <list of +Emotions+> ==]"
    config:
      max_tokens: 4096
      use_guidance: true
    output:
      document_type: dialogue-librarian
      weight: 0.2
    context:
      - action: flush
      - action: search_memories
        top_n: 20
    next: [brainstorm_response]

  brainstorm_response:
    speaker:
      type: persona
    guidance: |
      What questions remain from the dream? What threads want following?
      Begin with "[== {{ persona.name }}'s Emotional State: <list of +Emotions+> ==]"
      For "Brainstorming:"
    context:
      - action: search_memories
        document_types: [brainstorm]
        top_n: 10
    config:
      max_tokens: 4096
      model_role: research
    output:
      document_type: brainstorm
      weight: 0.6
    next: []
